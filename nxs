#! /bin/bash

# Luis Lavaire 2017, @Nitrux S.A.

# nxs is a simple software installer designed to manage
# AppImage packages. When install is requested, it looks
# for the requested package in local database, and, if
# found, then it installs it (downloads) in 
# $HOME/.local/apps.
#
# When deletion is requested, it looks if the app exists
# in the apps directory and if so, it just deletes it.
#
# It can update all the packages installed to the latest
# version available also. List the ones installed or
# available for installation is supported too.
#
# Very easy, very funny. =D

# - - - CONFIG FILES

# ${HOME}/.apps

_DB=".apps/.nxdb"
_APPS_DIR=".apps"
_NXDB="https://github.com/some/location/nxdb"


# - - - OUTPUTS

_fail() { echo -e "-\033[38;5;1m $@ \033[38;0;1m"; }

_echo() { echo -e "-\033[38;5;5m $@ \033[38;0;1m"; }


# - - - MAIN FUNCTIONS

_help() {
	_fail "USAGE: nxs [cmd]"

	echo "
  [install] : Install specified package(s).
  [remove]  : Uninstall specified package(s).
  [update]  : Update specified package(s).
              If no package is supplied, all packages are updated.
  [find]    : Find pakcages matching a given pattern."

	exit
}

app=''
ver=''

_install() {
	target=`grep "${app} ${ver}" "$_DB" | awk '{ print $3 }'`
	file="${app}-${ver}.x"
	_echo "Installing $file..."
	wget --quiet --show-progress  "$target" -O "$_APPS_DIR/$file"
	chmod a+x "$_APPS_DIR/$file"
}

_add() {
	[ -z "$1" ] && _help
	for pkg in "$@"; do
		name="$pkg"
		pkg=($(awk "/$pkg/ { print \$1,\$2;}" "$_DB"))
		[[ "$pkg" ]] || _echo "The package '$name' doesn't exist. Omitting"

		# TODO:
		# Need to handle multiple versions. Show them
		# to the user (if there are multiple versions,
		# of course) and let him select which one he
		# wants to install.

		while [[ "${#pkg[@]}" -gt 0 ]]; do
			app="$pkg"; pkg=( "${pkg[@]:1}" )
			ver="$pkg"; pkg=( "${pkg[@]:1}" )
			echo "${app}-${ver}"
		done
	done
	_echo "Done installing apps."
}

_del() {
	echo 1
}

_sy() {
	echo 2
}

_ls() {
	if [[ -z "$@" ]]; then
		awk '{ print $1 }' "$_DB" | sort | uniq
	else
		awk '{ print $1,$2 }' "$_DB" | grep "$@" | sort | uniq
	fi
}


# - - - MAIN PROGRAM

mkdir -p "$_APPS_DIR"
[ -f "$_DB" ] || wget "$_NXDB" -qO "$_DB"
cmd=`tr [:upper:] [:lower:] <<< $1`

shift
case "$cmd" in
	"install")	_add $@;;
	"remove")	_del $@;;
	"update")	_sy $@;;
	"find")		_ls $@;;
	*)			_help;;
esac
